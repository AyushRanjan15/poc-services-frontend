<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Noise Meter - Redenlab</title>
  <style>
    :root {
      --text: #e8e8ea;
      --muted: #a0a0a8;
      --border: #222;
      --btn-bg: rgba(255,255,255,0.06);
      --btn-bg-hover: rgba(255,255,255,0.12);
      --focus: #7aa7ff;
      --gauge-size: 280px;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      background: #000;
      color: var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
    }

    /* Top bar with Back to Home */
    .topbar {
      position: sticky; top: 0; z-index: 100;
      display: flex; align-items: center; gap: 12px;
      padding: 10px 14px;
      background: #000;
      color: var(--text);
      border-bottom: 1px solid var(--border);
    }
    .home-link {
      display: inline-flex; align-items: center; gap: 8px;
      color: var(--text);
      text-decoration: none;
      padding: 6px 10px; border-radius: 8px;
      background: var(--btn-bg);
    }
    .home-link:hover { background: var(--btn-bg-hover); }
    .home-link:focus { outline: none; box-shadow: 0 0 0 3px var(--focus); }
    .page-title { opacity: .85; font-size: 14px; margin-left: auto; }

    /* Content wrapper */
    .container {
      padding: 18px;
      max-width: 1000px;
      margin: 0 auto;
    }
    .card {
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px;
      background: #0d0d0f;
    }
    .card h2 { margin: 0 0 10px; font-size: 18px; }
    .muted { color: var(--muted); }

    /* Noise Meter Styles */
    .row {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 0.75rem;
      margin: 0.75rem 0;
      flex-wrap: wrap;
    }

    #visuals {
      height: 1rem;
      width: 0rem;
      background: black;
      border-radius: 0.5rem;
      transition: width 0.1s linear, background 0.1s linear;
    }

    #db {
      font-weight: 700;
      font-size: 1.4rem;
      min-width: 4rem;
      text-align: right;
    }

    button {
      padding: 0.6rem 1.2rem;
      background: var(--btn-bg);
      color: var(--text);
      border: 1px solid var(--border);
      border-radius: 8px;
      cursor: pointer;
      font-size: 1rem;
      font-weight: 500;
      transition: all 0.2s ease;
    }

    button:hover:not(:disabled) {
      background: var(--btn-bg-hover);
    }

    button:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }

    /* Gauge styling */
    .centered {
      display: flex;
      justify-content: center;
      align-items: center;
      width: 100%;
    }

    .gauge-wrap {
      width: var(--gauge-size);
      height: calc(var(--gauge-size) / 2 + 40px);
      position: relative;
      left: 10px;
    }

    .gauge {
      width: 100%;
      height: auto;
      display: block;
    }

    .needle {
      transform-origin: 140px 140px;
      transition: transform 0.08s linear;
    }

    .tick text {
      font-size: 10px;
      fill: #ddd;
    }

    .label-big {
      font-weight: 700;
      font-size: 20px;
      fill: var(--text);
      text-anchor: middle;
    }

    .quality-pill {
      display: inline-block;
      padding: 0.2rem 0.6rem;
      border-radius: 999px;
      font-weight: 600;
      font-size: 0.9rem;
    }

    .ok {
      background: #1a3a1a;
      color: #5ecc5e;
      border: 1px solid #2d5a2d;
    }

    .warn {
      background: #3a2f1a;
      color: #e6b35e;
      border: 1px solid #5a4a2d;
    }

    .bad {
      background: #3a1a1a;
      color: #e65e5e;
      border: 1px solid #5a2d2d;
    }

    .gauge-arc {
      transition: stroke 0.08s linear;
    }

    #status {
      color: var(--muted);
      font-style: italic;
    }

    @media (max-width: 768px) {
      .gauge-wrap {
        --gauge-size: 220px;
      }
      .row {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>
  <!-- Back to Home -->
  <header class="topbar">
    <a class="home-link" href="index.html" aria-label="Back to Home">
      <svg width="18" height="18" viewBox="0 0 24 24" aria-hidden="true">
        <path fill="currentColor" d="M14 7l-5 5 5 5V7z"></path>
      </svg>
      Home
    </a>
    <span class="page-title">Noise Meter</span>
  </header>

  <main class="container">
    <section class="card">
      <h2>Real-time dB Meter + Gauge</h2>
      <p class="muted">Monitor audio levels in real-time with visual feedback and quality indicators</p>

      <!-- Gauge + readout -->
      <div class="row" style="align-items:flex-start; gap:2rem; margin-top: 1.5rem;">
        <div class="centered">
          <div class="gauge-wrap">
            <!-- SVG semicircle gauge -->
            <svg class="gauge" viewBox="0 0 300 190" aria-label="dB gauge">
              <!-- Background arc -->
              <path d="M20,140 A120,120 0 0 1 260,140" fill="none" stroke="#333" stroke-width="18" />
              <!-- Foreground arc (colored by level) -->
              <path id="gaugeArc" class="gauge-arc" d="M20,140 A120,120 0 0 1 260,140" fill="none" stroke="#4e79a7" stroke-linecap="round" stroke-width="18" />

              <!-- Ticks -->
              <g class="tick" transform="translate(140,140)">
                <g transform="rotate(-90) translate(0,-140)">
                  <line y1="0" y2="0" stroke="#666" stroke-width="2"/>
                  <text y="-10" transform="rotate(90) translate(-10,18)">0</text>
                </g>
                <g transform="rotate(-45) translate(0,-140)">
                  <line y1="0" y2="0" stroke="#666" stroke-width="2"/>
                  <text y="-10" transform="rotate(45) translate(-6,18)">25</text>
                </g>
                <g transform="rotate(0) translate(0,-140)">
                  <line y1="0" y2="0" stroke="#666" stroke-width="2"/>
                  <text y="-10" transform="rotate(0) translate(-8,20)">50</text>
                </g>
                <g transform="rotate(45) translate(0,-140)">
                  <line y1="0" y2="0" stroke="#666" stroke-width="2"/>
                  <text y="-10" transform="rotate(-45) translate(-10,18)">75</text>
                </g>
                <g transform="rotate(90) translate(0,-140)">
                  <line y1="0" y2="0" stroke="#666" stroke-width="2"/>
                  <text y="-10" transform="rotate(-90) translate(-12,16)">100</text>
                </g>
              </g>

              <!-- Needle pivot + needle -->
              <circle cx="140" cy="140" r="5" fill="#888"/>
              <g id="needle" class="needle">
                <rect x="138" y="32" width="4" height="112" rx="2" ry="2" fill="#fff"/>
              </g>

              <!-- Big center label -->
              <text id="gaugeValue" x="140" y="130" class="label-big">0</text>
            </svg>
          </div>
        </div>

        <div>
          <div class="row">
            <span>Level (dB units):</span>
            <div id="visuals"></div>
            <span id="db">0</span>
          </div>
          <div class="row">
            <span>Quality:</span>
            <span id="quality" class="quality-pill ok">â€”</span>
          </div>
        </div>
      </div>

      <div class="row" style="margin-top: 1.5rem;">
        <button id="startBtn">Start Monitoring</button>
        <span id="status">idle</span>
      </div>
    </section>
  </main>

  <script>
    // Noise Meter Logic
    let localDbValues = [];
    const REFRESH_MS = 50;
    const OFFSET_DB = 0;
    const MAX_DB = 100;

    let color = 'green';
    let context, analyser, interval;

    const $ = (id) => document.getElementById(id);
    const clamp = (x, a, b) => Math.min(b, Math.max(a, x));

    function valueToAngle(v) {
      const ratio = clamp(v / MAX_DB, 0, 1);
      return -90 + ratio * 180;
    }

    function setNeedle(v) {
      const angle = valueToAngle(v);
      const needle = $('needle');
      if (needle) {
        needle.style.transform = `rotate(${angle}deg)`;
      }
    }

    function setGaugeArcColor(decibels) {
      let stroke = '#4e79a7';
      if (decibels < 50) stroke = '#2ca02c';
      else if (decibels < 70) stroke = '#d4a72c';
      else if (decibels < 90) stroke = '#f28e2b';
      else stroke = '#d62728';

      const gaugeArc = $('gaugeArc');
      if (gaugeArc) {
        gaugeArc.setAttribute('stroke', stroke);
      }
    }

    function setQualityPill(decibels) {
      const q = $('quality');
      if (!q) return;

      if (decibels < 50) {
        q.textContent = 'Quiet';
        q.className = 'quality-pill ok';
      } else if (decibels < 70) {
        q.textContent = 'Moderate';
        q.className = 'quality-pill ok';
      } else if (decibels < 90) {
        q.textContent = 'Noisy';
        q.className = 'quality-pill warn';
      } else {
        q.textContent = 'Too loud';
        q.className = 'quality-pill bad';
      }
    }

    function changeColor(decibels) {
      if (decibels < 50) color = 'green';
      else if (decibels < 70) color = 'yellow';
      else if (decibels < 90) color = 'orange';
      else color = 'red';

      const visuals = $("visuals");
      const db = $("db");

      if (visuals) {
        visuals.style.width = (decibels * 2 / 10) + "rem";
        visuals.style.background = (decibels >= 70) ? 'red' : '#666';
      }
      if (db) db.style.color = color;
    }

    function updateDb() {
      const dbEl = $("db");
      if (!dbEl) return;

      let volume = localDbValues.length
        ? Math.round(localDbValues.reduce((a,b)=>a+b, 0) / localDbValues.length)
        : 0;
      if (!isFinite(volume)) volume = 0;

      dbEl.innerText = volume;
      localDbValues = [];
      changeColor(volume);

      setNeedle(volume);
      const gaugeValue = $('gaugeValue');
      if (gaugeValue) gaugeValue.textContent = volume;
      setGaugeArcColor(volume);
      setQualityPill(volume);
    }

    async function startNoiseMeter() {
      const statusEl = $("status");
      const startBtn = $("startBtn");

      if (statusEl) statusEl.textContent = "requesting micâ€¦";

      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });
        if (statusEl) statusEl.textContent = "listening";

        context = new (window.AudioContext || window.webkitAudioContext)();
        const source = context.createMediaStreamSource(stream);
        const processor = context.createScriptProcessor(2048, 1, 1);
        analyser = context.createAnalyser();

        analyser.smoothingTimeConstant = 0.8;
        analyser.fftSize = 256;

        source.connect(analyser);
        analyser.connect(processor);
        processor.connect(context.destination);

        processor.onaudioprocess = () => {
          const data = new Uint8Array(analyser.frequencyBinCount);
          analyser.getByteFrequencyData(data);
          let rms = 0;
          for (let i = 0; i < data.length; i++) {
            if (data[i] > 120) data[i] = 120;
            rms += data[i] * data[i];
          }
          rms = Math.sqrt(rms / data.length);
          const value = rms + OFFSET_DB;
          localDbValues.push(value);
        };

        if (interval) clearInterval(interval);
        interval = setInterval(updateDb, REFRESH_MS);
        if (startBtn) startBtn.disabled = true;

      } catch (e) {
        console.error(e);
        if (statusEl) statusEl.textContent = "mic denied/unavailable";
      }
    }

    document.addEventListener('DOMContentLoaded', function() {
      const startBtn = $("startBtn");
      if (startBtn) startBtn.addEventListener("click", startNoiseMeter);
    });

    // Keyboard shortcut to return home
    document.addEventListener('keydown', e => {
      if (e.key === 'Escape') window.location.href = 'index.html';
    });
  </script>
</body>
</html>
